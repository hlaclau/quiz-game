name: Tests

on:
  pull_request:
    branches: [master, dev]
  push:
    branches: [master, dev]

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run tests
        id: tests
        continue-on-error: true
        run: |
          cd apps/server
          bun test 2>&1 | tee test-output.txt
          echo "exit_code=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT

      - name: Display test results
        if: always()
        run: |
          cd apps/server
          if [ -f test-output.txt ]; then
            cat test-output.txt
          fi

      - name: Tests passed
        if: steps.tests.outputs.exit_code == '0'
        run: echo "✅ All tests passed! This PR is ready for review."

      - name: Tests failed
        if: steps.tests.outputs.exit_code != '0'
        run: |
          # Print a blank line for readability before the failure message.
          echo ""
          echo "❌ Some tests failed. Please check the test output above to see which tests need to be fixed."
          exit 1
